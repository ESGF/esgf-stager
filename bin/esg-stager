#!/bin/bash

#####
# esg-stager
# Installs and configures SRM/Bestman stager for staging files from
# deep storage (e.g., HPSS) to user facing disk for download.
#****************************************************************************
#*                                                                          *
#*  Organization: Oak Ridge National Laboratory (ORNL)                      *
#*   Directorate: Computing and Computational Sciences Directorate          *
#*      Division: Center for Computational Sciences                         *
#*         Group: Technology Integration                                    *
#*       Program: CSSEF                                                     *
#*       Project: Earth Systems Grid (ESG) Data Node Software Stack         *
#*       Authors: Tom Barron (tbarron@ornl.gov)                             *
#*                John Harney (harneyjf@ornl.gov)                           *
#****************************************************************************
#*
#* License here?
#*
#****************************************************************************
#####

# Description: Installation of the esgf-stager component. Meant to be
#              called by esg-node at install time.

init() {
    echo $*
}

setup_stager() {
    echo setup_srm $*
    setup_srm $*
}

write_install_log() {
    echo $*
}

setup_srm() {
    # handle arguments
    while getopts Gb:c: flag; do
        case $flag in
            b)
                local bestman_path=$OPTARG
                echo "BESTMAN_PATH = $bestman_path"
            ;;
            c)
                local hpss_proxy_certificate_location=$OPTARG
                echo "hpss_proxy_certificate_location = $hpss_proxy_certificate_location"
            ;;
            G)
                gridftp_restart=1
                echo "Will restart gridftp"
            ;;
        esac
    done

    # 1 - Bestman setup
    runcmd setup_bestman -b $bestman_path

    # 2 - Copy the esg2-sdnn1 certificate into /etc/grid-security/certificates
    if [[ -e $hpss_proxy_certificate_location ]]; then
        cp $hpss_proxy_certificate_location/* /etc/grid-security/certificates
    fi

    # 3 - Set the ports for globus (i.e. call esg-gridftp-restart)
    if [[ $griftp_restart ]]; then
        gridftp-restart
    fi

    # 4 - Obtain a certificate via myproxy-logon (using globus services)
    # $GLOBUS_HOME/bin/myproxy-logon -s esg -l <username>
    # NOTE: certificate must be for user "tomcat" 
    # (i.e. /tmp/x509uxxx where xxx is the tomcat user on the system)



    # 5 - Set CLASSPATH for tomcat (to be used with Bestman and Axis)

    # 6 - Write the srm.properties file (for front end)

    # 7 - Create new schema in postgres
    #
    # file_id varchar(128),dataset_id varchar(128),timeStamp varchar(128), 
    # expiration varchar(128), bestmanNumber varchar(128), 
    # primary key (file_id,dataset_id));
    #

    # 8 - Pull esgf-stager from repo
    cd /usr/local/src
    if [[ ! -d /usr/local/src/esgf-stager ]] ; then
      /usr/local/git/bin/git clone https://github.com/ESGF/esgf-stager.git
    fi
    cd esgf-stager
    /usr/local/git/bin/git checkout devel-newStager
    /usr/local/ant/bin/ant make_war

    # 9 - Deploy in tomcat

}

setup_bestman() {
    local localdir=`pwd`
    local bestman_parent=${bestman_path:-/usr/local}
    local bm_path=${bestman_parent}/bestman2
    local bestman_dist=bestman2-2.3.0.tar.gz
    local bestman_url=https://codeforge.lbl.gov/frs/download.php/402

    # 1 - Get bestman
    runcmd cd /tmp

    # remove any old tarball sitting around
    if [[ -e ${bestman_dist} ]]; then
        runcmd rm ${bestman_dist}
    fi

    # fetch it
    runcmd wget ${bestman_url}/${bestman_dist}

    # 2 - untar into $bestman_parent and set the BESTMAN2_HOME variable
    # NOTE: We have to create directory ${bm_path}/dist for configure to work, so 
    #       we do that here
    runcmd mkdir -p ${bm_path}/dist

    runcmd cd ${bestman_parent}

    runcmd tar zxf /tmp/${bestman_dist}

    # 3 - run configure in BESTMAN2_HOME/setup
    # configure fails because of not finding axis 1.4. Do we need to fetch
    #   that from somewhere?
    runcmd cd ${bm_path}/setup
    export CLASSPATH=`find ${bm_path}/lib -name "*.jar" | xargs echo | sed -e "s/ /:/g"`
    ./configure

#     # 4 - set the configuration parameters in BESTMAN2_HOME/conf/bestman2.rc and BESTMAN2_HOME/etc/bestman2 using the inputs
#     # TODO: Need to identify the parameters to be customized from inputs
#     # another option would be to use awk or sed to do this edit
# 
    runcmd cd ../conf
    runcmd awk -f ${localdir}/bestman2_rc_edits.awk < bestman2.rc.samples > bestman2.rc

    # 5 - write grid-mapfile and save to $GridMapFileName (see above)

    # 6 - start bestman

    runcmd cd $localdir
}

gridftp_restart() {
    PIDS=`ps -ef | grep -v grep | grep -- "globus-gridftp-server" \
         | awk '{ printf "%s ", $2; }'`
    echo $PIDS
    if [[ "$PIDS" != "" ]]; then
        kill -9 $PIDS
    fi

    . /etc/esg.env
    local X509_CERT_DIR=/etc/grid-security/certificates
    local GLOBUS_TCP_PORT_RANGE=50000,51000
    local GLOBUS_TCP_SOURCE_RANGE=50000,51000
    local GSI_AUTHZ_CONF=/etc/grid-security/gsi-authz.conf
    local GLOBUS_USAGE_DEBUG=MESSAGES,/esg/log/esg-server-usage-gridftp.log

    export GLOBUS_GSI_AUTHZ_DEBUG_LEVEL=2
    export GLOBUS_GSI_AUTHZ_DEBUG_FILE=/tmp/GFTPAUTHLOG
    local JAVA_HOME=/usr/local/java

    local LOGFILE=/var/log/gridftp-esg
    echo "* * * Restarting servers at `date \"+%Y.%m%d %H:%M:%S\"`" >> $LOGFILE

    #CHROOT="-chroot-path /lustre/esgfs"
    #CHROOT="-chroot-path /esg/gridftp_root"

    echo "CHROOT: '$CHROOT'"

    CMD="/usr/local/globus/sbin/globus-gridftp-server \
        -no-cas $CHROOT -d ALL -l $LOGFILE"

    nohup $CMD -p 2811 >> $LOGFILE 2>&1 &

    nohup $CMD -p 2812 >> $LOGFILE 2>&1 &
}

runcmd() {
    echo "$*"
    $*
    local status=$?
    if [[ $status != 0 ]]; then
        echo "'$*' failed"
        exit $status
    fi
}

